@Component
@RequiredArgsConstructor
public class BffTokenRelayFilter implements GlobalFilter, Ordered {

    private final ReactiveClientRegistrationRepository clientRegistrations;
    private final ServerOAuth2AuthorizedClientRepository authorizedClients;

    @Override
    public int getOrder() {
        return 200; // après les filtres de sécurité
    }

    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        // Configure le client OAuth2 "bff"
        ServerOAuth2AuthorizedClientExchangeFilterFunction oauth =
                new ServerOAuth2AuthorizedClientExchangeFilterFunction(clientRegistrations, authorizedClients);
        oauth.setDefaultClientRegistrationId("bff");

        // Utilise ce client pour récupérer le token technique
        return oauth.authorize(exchange)
                .flatMap(auth -> {
                    String token = auth.getAccessToken().getTokenValue();

                    // Ajoute ce token dans la requête qui part vers le service distant
                    ServerHttpRequest request = exchange.getRequest()
                            .mutate()
                            .header("Authorization", "Bearer " + token)
                            .build();

                    return chain.filter(exchange.mutate().request(request).build());
                });
    }
}
